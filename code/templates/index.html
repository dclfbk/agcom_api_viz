<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="../static/style.css">
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"/>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
</head>



<body>
  <div class="searchPol">
    <form id="form_pol">
      <input type="radio" id="politician" value="politician" name="choose_pol" onclick="handleOptionChange(this)">
      <label for="politician">Politician</label><br>
      <input type="radio" id="political_group" value="political_group" name="choose_pol" onclick="handleOptionChange(this)">
      <label for="political_group">Political Group</label>
    </form>
    <select id="select_pol" style="width: 100%;" multiple="multiple">
      <option></option>
    </select>
  </div>
  <div>
    <p>from: <input type="date" id="start_date" onchange="limitEndDate()"/></p>  
    <p>to: <input type="date"  id="end_date"/></p>
  </div>
  <div>
    <form id="cb">
      <input type="checkbox" id="news" value="news" name="choose_type" checked onclick="changeType()" >
      <label for="news">News</label><br>
      <input type="checkbox" id="speech" value="speech" name="choose_type" checked onclick="changeType()">
      <label for="speech">Speech</label>
    </form>
  </div>

  <button id='barChartButton' onclick="barChart()">Bar Chart</button>
  <button id='pieChartButton'onclick="pieChart()">Pie Chart</button>
  <button id='calendarChartButton'onclick="calendarChart()">Calendar Chart</button>
  <button id='lineChartButton'onclick="lineChart()">Line Chart</button>
  <button id='radarChartButton'onclick="radarChart()">Radar Chart</button>
  

  <div id="barChart" style="width: 1000px; height:600px; display: none;"></div>
  <div id="pieChart" style="width: 1000px; height:600px; display: none;"></div>
  <div id="calendarChart" style="width: 1000px; height:1500px; display: none;"></div>
  <div id="lineChart" style="width: 1000px; height:600px; display: none;"></div>
  <div id="radarChart" style="width: 1000px; height:600px; display: none;"></div>

  <script>

    //function to call APIs passing url
    async function fetchData(url) {
      try {
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        const data = await response.json();
        return data;
      } catch (error) {
        console.error('Errore nel recupero dei dati:', error);
      }
    }
    

    // initializing select pol
    $(document).ready(function() {
      $('#select_pol').select2({
        placeholder: 'Cerca politico',
        allowClear: true,
        maximumSelectionLength: 1
      });
      $('#barChartButton').click(function() {
        $('#select_pol').select2({
          maximumSelectionLength: 1
        });
        if($('#select_pol').val().length != 0){
          temp = $('#select_pol').val()[0];
          $('#select_pol').val([temp]).trigger('change');
        }
      })
      $('#pieChartButton').click(function() {
        $('#select_pol').select2({
          maximumSelectionLength: 1
        });
        if($('#select_pol').val().length != 0){
          temp = $('#select_pol').val()[0];
          $('#select_pol').val([temp]).trigger('change');
        }
      })
      $('#calendarChartButton').click(function() {
        $('#select_pol').select2({
          maximumSelectionLength: 1
        });
        if($('#select_pol').val().length != 0){
          temp = $('#select_pol').val()[0];
          $('#select_pol').val([temp]).trigger('change');
        }
      })
      $('#lineChartButton').click(function() {
        $('#select_pol').select2({
          maximumSelectionLength: 4
        });
      })
      $('#radarChartButton').click(function() {
        $('#select_pol').select2({
          maximumSelectionLength: 4
        });
      })
    });


    // initializing politicians/political group list (select)
    const select_pol = document.getElementById("select_pol");
    function handleOptionChange(radio) {
      var options = [];
      while (select_pol.options.length > 0) {
        select_pol.remove(0);
      }
      const o = document.createElement("option");
      select_pol.appendChild(o);
      if (radio.value == 'politician'){
        fetchData("/v1/politicians").then(result => {
          result["politicians"].forEach(valore => {
            var option = document.createElement("option");
            option.value = valore;
            option.text = valore;
            select_pol.appendChild(option);
          });
        })
      } else if (radio.value == 'political_group'){
        fetchData("/v1/political_groups").then(result => {
          result["political_groups"].forEach(valore => {
            var option = document.createElement("option");
            option.value = valore;
            option.text = valore;
            select_pol.appendChild(option);
          });
        })
      }
    }


    // initialize dates
    const start_date = document.getElementById("start_date");
    const end_date = document.getElementById("end_date");

    fetchData("/v1/dates").then(result => {
      start_date.value = result["first_date"];
      start_date.min = result["first_date"];
      start_date.max = result["end_date"];
      end_date.value = result["end_date"];
      end_date.min = result["first_date"];
      end_date.max = result["end_date"];
    })

    async function limitEndDate(){
      end_date.min = start_date.value;
      if(Number(end_date.value.split('-')[0]) < Number(start_date.value.split('-')[0]) ||
        (Number(end_date.value.split('-')[0]) == Number(start_date.value.split('-')[0]) &&
        Number(end_date.value.split('-')[1]) < Number(start_date.value.split('-')[1])) ||
        (Number(end_date.value.split('-')[1]) == Number(start_date.value.split('-')[1]) &&
        Number(end_date.value.split('-')[2]) < Number(start_date.value.split('-')[2]))){
        end_date.value = start_date.value;  
      }
    }


    // change checkbox type
    var cb = "both";
    async function changeType(){
      const news = document.getElementById("news");
      const speech = document.getElementById("speech");
      if (news.checked == true && speech.checked == true){
        cb = "both";
      }else if (news.checked == true){
        cb = "news";
      }else if (speech.checked == true){
        cb = "speech";
      }else{
        cb = "none";
      }
    }


    // Bar Chart
    async function barChart(){
      if($('#select_pol').val().length == 0){ return 0; }
      document.getElementById('pieChart').style.display = 'none';
      document.getElementById('calendarChart').style.display = 'none';
      document.getElementById('lineChart').style.display = "none";
      document.getElementById('radarChart').style.display = "none";
      const p = document.getElementById("politician");
      const pg = document.getElementById("political_group");
      if(p.checked == true){
        var t = "/v1/politicianTopics/";
      }else if(pg.checked == true){
        var t = "/v1/polGroupTopics/";
      } else { return 0; }
      const url = t + $('#select_pol').val()[0] + 
                  "?start_date_=" + start_date.value.replace(/-/g, '%2F') + 
                  "&end_date_=" + end_date.value.replace(/-/g, '%2F') + 
                  "&kind_=" + cb;
      fetchData(url).then(result => {
        var bC = document.getElementById('barChart');
        bC.style.display = "block";
        var barChart = echarts.init(bC);
        var topics = [];
        var minutes = [];
        for(let i = 0; i < result["topics"].length; i++){
          if(result["topics"][i]["interventions"] != 0){
            topics.push(result["topics"][i]["topic"]);
            minutes.push(result["topics"][i]["interventions"]);
          }
        }
        option = {
          title: {
            text: 'Interventions in channel',
            subtext: 'Here we can analyze what type of topic a politician talked about',
            left: 'center'
          },
          xAxis: {
            type: 'category',
            data: topics,
            axisLabel: false
          },
          yAxis: {
            type: 'value'
          },
          tooltip: {
            trigger: 'item'
          },
          series: [
            {
              data: minutes,
              type: 'bar',
              emphasis: {
                itemStyle: {
                  shadowBlur: 10,
                  shadowOffsetX: 0,
                  shadowColor: 'rgba(0, 0, 0, 0.5)'
                }
              }
            }
          ]
        };
        barChart.setOption(option);
      });
    }


    // Pie Chart
    async function pieChart(){
      if($('#select_pol').val().length == 0){ return 0; }
      document.getElementById('barChart').style.display = "none";
      document.getElementById('calendarChart').style.display = 'none';
      document.getElementById('lineChart').style.display = "none";
      document.getElementById('radarChart').style.display = "none";
      const p = document.getElementById("politician");
      const pg = document.getElementById("political_group");
      if(p.checked == true){
        var t = "/v1/politicianChannels/";
      }else if(pg.checked == true){
        var t = "/v1/polGroupChannels/";
      } else { return 0; }
      const url = t + $('#select_pol').val()[0] + 
                  "?start_date_=" + start_date.value.replace(/-/g, '%2F') + 
                  "&end_date_=" + end_date.value.replace(/-/g, '%2F') + 
                  "&kind_=" + cb;
      fetchData(url).then(result => {
        var pC = document.getElementById('pieChart');
        pC.style.display = "block";
        var pieChart = echarts.init(pC);
        var final = [];
        for(let i = 0; i < result["channels"].length; i++){
          var j = {};
          j["name"] = result["channels"][i]["channel"];
          j["value"] = result["channels"][i]["interventions"];
          if(j["value"] != 0){ final.push(j); }
        }
        if (cb == 'none'){ final = []; }
        option = {
          title: {
            text: 'Interventions in channel',
            subtext: 'Here we can analyze the time a channel spends for a politician',
            left: 'center'
          },
          tooltip: {
            trigger: 'item'
          },
          legend: {
            orient: 'vertical',
            left: 'left'
          },
          series: [
            {
              type: 'pie',
              radius: '50%',
              data: final,
              emphasis: {
                itemStyle: {
                  shadowBlur: 10,
                  shadowOffsetX: 0,
                  shadowColor: 'rgba(0, 0, 0, 0.5)'
                }
              }
            }
          ]
        };
        pieChart.setOption(option);
      });
    }


    // Calendar Chart
    var calendarChartInstance = null;

    async function calendarChart(){
      if (calendarChartInstance !== null) {
        calendarChartInstance.dispose();
      }
      if($('#select_pol').val().length == 0){ return 0; }
      document.getElementById('barChart').style.display = "none";
      document.getElementById('pieChart').style.display = "none";
      document.getElementById('lineChart').style.display = "none";
      document.getElementById('radarChart').style.display = "none";
      const p = document.getElementById("politician");
      const pg = document.getElementById("political_group");
      if(p.checked == true){
        var t = "/v1/interventionsPoliticianPerDay/";
      }else if(pg.checked == true){
        var t = "/v1/interventionsPoliticalGroupPerDay/";
      } else { return 0; }
      const url = t + $('#select_pol').val()[0] + 
                  "?start_date_=" + start_date.value.replace(/-/g, '%2F') + 
                  "&end_date_=" + end_date.value.replace(/-/g, '%2F') + 
                  "&kind_=" + cb;
      fetchData(url).then(result => {
        var cC = document.getElementById('calendarChart');
        cC.style.display = "block";
        calendarChartInstance = echarts.init(cC);
        var interv = result["interventions"]
        var max_value = result["max_value"]
        var begin_year = result["begin year"]
        var final_year = result["final year"]
        var calendar = []
        var series = []
        interv.forEach(function(x, index) {
          x.forEach(function(y, index2) {
            interv[index][index2][0] = +echarts.time.parse(interv[index][index2][0]);
          })
        });
        for (var i = begin_year; i <= final_year; i++ ){
          calendar.push({top: (100 + (i-begin_year)*200), range: i.toString(), cellSize: ['auto', 20]});
        }
        for (var i = begin_year; i <= final_year; i++ ){
          series.push({type: 'heatmap', coordinateSystem: 'calendar', calendarIndex: (i-begin_year), data: interv[i-begin_year]});
        }
        option = {
          tooltip: {
            position: 'top'
          },
          visualMap: {
            min: 0,
            max: max_value,
            calculable: true,
            orient: 'horizontal',
            left: 'center',
            top: 'top'
          },
          calendar: calendar,
          series: series
        };
        calendarChartInstance.setOption(option);
      });
    }


    // Line chart
    async function lineChart(){
      if($('#select_pol').val().length == 0){ return 0; }
      document.getElementById('barChart').style.display = "none";
      document.getElementById('pieChart').style.display = "none";
      document.getElementById('calendarChart').style.display = 'none';
      document.getElementById('radarChart').style.display = "none";
      const p = document.getElementById("politician");
      const pg = document.getElementById("political_group");
      if(p.checked == true){
        var t = "/v1/interventionsPoliticianPerYear/";
      } else if (pg.checked == true){
        var t = "/v1/interventionsPoliticalGroupPerYear/";
      } else { return 0; }
      var series = [];
      var years;
      var politicians = []
      $('#select_pol').val().forEach(function(value) {
        const url = t + value + 
                "?start_date_=" + start_date.value.replace(/-/g, '%2F') + 
                "&end_date_=" + end_date.value.replace(/-/g, '%2F') + 
                "&kind_=" + cb;
        fetchData(url).then(result => {
          years = result["years"];
          var interventions = result["interventions"];
          series.push(interventions);
          if(p.checked == true){ 
            politicians.push(result["politician"])
          } else if (pg.checked == true){ 
            politicians.push(result["political group"]) 
          }
        });
      });
      setTimeout(() => {
        var lC = document.getElementById('lineChart');
        lC.style.display = "block";
        var lineChart = echarts.init(lC);
        option = {
          xAxis: {
            type: 'category',
            data: years
          },
          yAxis: {
            type: 'value'
          },
          title: {
            text: 'Intervention per year',
            subtext: 'Here we can analyze the interventions throughout the years',
            left: 'center',
          },
          legend: {
            data: politicians,
            left: 'right',
            orient: 'vertical',
            formatter: function(name) {
              if (name.length > 35) {
                var index = 35;
                  while (name.charAt(index) !== ' ' && index > 0) {
                      index--;
                  }
                  if (index === 0) {
                      index = 35; 
                  }
                  return name.substr(0, index) + '\n' + name.substr(index);
              } else {
                  return name;
              }
            }
          },
          tooltip: {
            trigger: 'item'
          },
          series: [
            {
              name: politicians[0],
              data: series[0],
              type: 'line'
            },
            {
              name: politicians[1],
              data: series[1],
              type: 'line'
            },
            {
              name: politicians[2],
              data: series[2],
              type: 'line'
            },
            {
              name: politicians[3],
              data: series[3],
              type: 'line'
            }
          ]
        };
        lineChart.setOption(option);
      }, 500);
    }


    // Radar Chart
    async function radarChart(){
      if($('#select_pol').val().length == 0){ return 0; }
      document.getElementById('barChart').style.display = "none";
      document.getElementById('pieChart').style.display = "none";
      document.getElementById('calendarChart').style.display = 'none';
      document.getElementById('lineChart').style.display = "none";
      const p = document.getElementById("politician");
      const pg = document.getElementById("political_group");
      if(p.checked == true){
        var t = "/v1/politicianTopics/";
      }else if(pg.checked == true){
        var t = "/v1/polGroupTopics/";
      } else { return 0; }
      var politicians = [];
      var values = [];
      $('#select_pol').val().forEach(function(value) {
        const url = t + value + 
                  "?start_date_=" + start_date.value.replace(/-/g, '%2F') + 
                  "&end_date_=" + end_date.value.replace(/-/g, '%2F') + 
                  "&kind_=" + cb;
        fetchData(url).then(result => {
          if(p.checked == true){
            politicians.push(result["politician"]);
          }else if(pg.checked == true){
            politicians.push(result["political group"]);
          }
            values.push(result["topics"]);
        });
      });
      setTimeout(() => {
        var minutes = [];
        var topics = [];
        var max_value = [];
        values.forEach(function(value) {
          var temp = [];
          value.forEach(function(v) {
            temp.push(v["minutes"]);
          });
          minutes.push(temp);
        });
        max_min = [];
        values[0].forEach(function(t) {
          topics.push(t["topic"]);
          max_min.push(0)
        });
        values.forEach(function(data) {
          data.forEach(function(x, index) {
            if(max_min[index] < x["minutes"]){
              max_min[index] = x["minutes"] + x["minutes"]/5;
            }
            else{}
          });
        });
        var rC = document.getElementById('radarChart');
        rC.style.display = "block";
        var radarChart = echarts.init(rC);
        var indicator = [];
        var data = [];
        topics.forEach(function(f, index){
          indicator.push({name: f, max: max_min[index]})
        });
        politicians.forEach(function(p, index){
          data.push({name: p, value: minutes[index]})
        });
        option = {
          title: {
            text: 'Minutes of speaking',
            subtext: 'Here we can analyze how much a politician/poolitical group talks about a topic',
            left: 'center',
          },
          legend: {
            data: politicians,
            left: 'left',
            orient: 'vertical',
            formatter: function(name) {
              if (name.length > 35) {
                var index = 35;
                  while (name.charAt(index) !== ' ' && index > 0) {
                      index--;
                  }
                  if (index === 0) {
                      index = 35; 
                  }
                  return name.substr(0, index) + '\n' + name.substr(index);
              } else {
                  return name;
              }
            }
          },
          tooltip: {
            trigger: 'item'
          },
          radar: {
            indicator: indicator,
            center: ['50%', '55%']
          },
          series: [
            {
              name: 'Minutes politicians',
              type: 'radar',
              data: data
            }
          ]
        };


        radarChart.setOption(option);
      }, 500);
    }

  </script>
</body>

